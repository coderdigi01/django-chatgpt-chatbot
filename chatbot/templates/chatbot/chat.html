{% extends 'base.html' %}

{% block content%}

<div class="container mt-5">
    <h3 class="text-center mb-4">Django Chatbot</h3>

    <div class="chat-box mb-4" id="chat-container">
        {% for chat in chats %}
            <div class="bot-msg">
                <div class="message"><strong>Bot:</strong> {{ chat.bot_response }}</div>
            </div>
            <div class="user-msg">
                <div class="message"><strong>You:</strong> {{ chat.user_message }}</div>
            </div>
        {% endfor %}
    </div>

    <form id="chat-form" method="post">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" class="form-control" name="message" id="message-input" placeholder="Type your message..." required>
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<script>
    const form = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const chatContainer = document.getElementById("chat-container");

    form.addEventListener("submit", async function(e) {
        e.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Show user message
        chatContainer.innerHTML += `
            <div class="user-msg">
                <div class="message"><strong>You:</strong> ${userMessage}</div>
            </div>
        `;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        messageInput.value = "";

        // Send request
        const response = await fetch("", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({ message: userMessage }),
        });
        const data = await response.json();

        // Show bot response
        chatContainer.innerHTML += `
            <div class="bot-msg">
                <div class="message"><strong>Bot:</strong> ${data.response}</div>
            </div>
        `;
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
</script>
{%endblock%}